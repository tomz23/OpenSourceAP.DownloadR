---
title: "Machine Learning Portfolio Example"
output: html_document
---

# Machine Learning Portfolio Example

This example illustrates how to use all Chen-Zimmermann predictors, together with CRSP data. We'll use the `OpenSourceAP.DownloadR` package to download the Chen-Zimmermann predictors, merge with monthly CRSP, fit returns to lagged signals, and form portfolios in out-of-sample tests. Specifically, we'll use a "groovy" model (fit on the 1960s and 1970s) to try to predict returns during hair metal (1980s), gangsta rap (1990s), emo (2000s), and other more recent samples. Does the groovy model work even in the TSwift (and that Chiefs guy) era?

Downloading all of the signals takes some time and requires substantial RAM. It also requires a WRDS account, since some predictors require data from WRDS (size, short-term reversal, price).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# devtools::install_github("tomz23/OpenSourceAP.DownloadR")
library(OpenSourceAP.DownloadR

```

```{r init}
# Initialize OpenAP
openap = OpenAP$new()
```

<span style="color: orange; font-weight: bold;">Optional:</span> By default, we'll use all 212 signals for forming portfolios. This takes about 35 minutes on a desktop with with 64 GB of RAM.

You may want to reduce nsignals_for_ml for a faster run or a smaller machine. We found nsignals_for_ml = 20 runs quickly on a laptop with 16 GB of RAM. But it won't reproduce the nice results in Gu, Kelly, Xiu (2020); Chen and McCoy (2024); and elsewhere.


```{r}
# User-specified number of signals for ML
nsignals_for_ml = 20
```


# Download data
You'll have to enter your WRDS credentials twice: once to download the CRSP returns, and once to download all Chen-Zimmermann predictors (including size, short-term reversal, and price). The downloads take a couple minutes in total. We keep only standard common stocks on major exchanges (see https://github.com/OpenSourceAP/CrossSection/issues/133).

```{r}
connect <- dbConnect(
        RPostgres::Postgres(),
        host = 'wrds-pgdata.wharton.upenn.edu',
        port = 9737,
        dbname = 'wrds',
        sslmode = 'require',
        user = Sys.getenv("WRDS_USER"),  # alternatively manually enter WRDS credentials here
        pass = Sys.getenv("WRDS_PASS")   # alternatively manually enter WRDS credentials here
      )

query <- "SELECT a.permno, a.date, a.ret*100 as ret 
          FROM crsp.msf as a
          JOIN crsp.msenames as b
            ON a.permno = b.permno
            AND a.date >= b.namedt
            AND a.date <= b.nameendt
          WHERE b.shrcd in (10, 11, 12) 
          AND b.exchcd in (1, 2, 3)"

crsp_data <- dbGetQuery(connect, query)
dbDisconnect(connect)

crsp_data <- crsp_data  |>
        mutate(
          yyyymm = as.integer(format(date, "%Y%m")))
str(crsp_data)
```
WRDS recommends setting up a .pgpass file.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done


